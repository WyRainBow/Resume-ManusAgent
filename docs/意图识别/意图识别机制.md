# 意图识别机制

**文档版本**: 2.0
**最后更新**: 2026-01-06

## 概述

OpenManus 采用**简化的意图识别 + LLM 工具路由**方案，在保持灵活性的同时优化性能。

**设计理念**:
- **最小化意图枚举**: 仅保留必须在代码层面特殊处理的意图
- **LLM 自主决策**: 其他场景由 LLM 根据工具描述和上下文判断
- **可扩展性**: 添加新工具无需修改意图类型
- **常识处理**: LLM 直接回答常识问题，不调用工具

## 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                          Manus Agent                            │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     think() 方法                          │  │
│  │                                                           │  │
│  │  1. 获取用户输入                                           │  │
│  │         │                                                 │  │
│  │         ▼                                                 │  │
│  │  2. 简化意图识别 (仅识别特殊意图)                         │  │
│  │         │                                                 │  │
│  │         ▼                                                 │  │
│  │  3. 路由决策                                              │  │
│  │     ├─ GREETING → 直接返回问候                            │  │
│  │     ├─ LOAD_RESUME → 检查重复 → 调用工具                  │  │
│  │     └─ UNKNOWN → LLM 根据工具描述自主决策                  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              ConversationStateManager                      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │        classify_intent_with_llm()                   │  │
│  │  │  - 仅识别: greeting / load_resume / unknown        │  │
│  │  │  - 返回意图 + 置信度                                │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 意图类型（简化版）

| 意图 | 说明 | 处理方式 |
|------|------|----------|
| `GREETING` | 用户问候 | 直接返回问候语 |
| `LOAD_RESUME` | 加载简历 | 检查重复后调用 cv_reader_agent |
| `UNKNOWN` | 其他所有情况 | 交由 LLM 根据工具描述和上下文处理 |

**设计原则**:
- 只在代码层面处理**必须特殊化**的场景
- 其他所有判断交给 LLM 自主决策
- 工具描述 (description) 是 LLM 决策的关键依据

## 工作流程

### 1. 意图识别流程

```
用户输入
    │
    ▼
┌───────────────────────────────────────────────┐
│   简化的 LLM 分类                             │
│   - 仅判断是否为 greeting / load_resume       │
│   - 其他全部归为 unknown                      │
└───────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────┐
│   返回结果                                     │
│   {                                           │
│     "intent": "greeting/load_resume/unknown", │
│     "confidence": float,                      │
│     "reasoning": str                          │
│   }                                           │
└───────────────────────────────────────────────┘
```

### 2. 路由决策流程

```
意图识别结果
    │
    ▼
┌───────────────────────────────────────────────┐
│   判断意图类型                                 │
└───────────────────────────────────────────────┘
    │
    ├── GREETING ──→ 直接返回问候
    │
    ├── LOAD_RESUME ──→ 检查是否重复加载
    │                     │
    │                     ├── 已加载 ──→ 跳过，返回成功
    │                     └── 未加载 ──→ 调用 cv_reader_agent
    │
    └── UNKNOWN ──→ LLM 根据以下判断:
                      - 系统提示词 (工具列表)
                      - 工具描述 (description)
                      - 对话上下文
                      - 是否常识问题
```

## LLM 工具路由机制

### 核心原则

LLM 在处理 UNKNOWN 意图时，遵循以下原则：

1. **简历相关任务** → 使用工具
2. **常识性问题** → 直接回答，不调用工具
3. **理解上下文** → 考虑对话历史和简历状态

### 工具描述示例

```python
# CVReaderAgentTool
description = """Load resume from file path.
Use this when user wants to load or read a resume file."""

# CVAnalyzerAgentTool
description = """Analyze resume quality and content.
Use this when user wants to analyze, evaluate, or diagnose resume."""

# CVEditorAgentTool
description = """Edit resume content.
Use this when user wants to modify, update, or change resume information."""
```

### LLM 决策示例

| 用户输入 | LLM 判断 | 行为 |
|---------|---------|------|
| "分析简历" | 简历任务 | 调用 cv_analyzer_agent |
| "把学校改成北大" | 编辑任务 | 调用 cv_editor_agent |
| "什么是985" | 常识问题 | 直接回答，不用工具 |
| "中山大学怎么样" | 常识问题 | 直接回答，不用工具 |
| "我是哪个学校的" | 查询简历 | 读取已加载的简历数据 |

## 代码实现

### 意图枚举 (app/memory/conversation_state.py)

```python
class Intent(str, Enum):
    """用户意图 - 仅保留需要在代码层面特殊处理的意图"""
    GREETING = "greeting"   # 问候 - 直接返回，不走 LLM
    LOAD_RESUME = "load_resume"  # 加载简历 - 需检查重复
    UNKNOWN = "unknown"     # 其他 - 交由 LLM 判断
```

### 简化的意图识别提示词

```python
prompt = f"""你是一个意图识别助手。根据用户输入判断是否为特殊意图。

## 用户输入
"{user_input}"

## 意图类型
- greeting: 问候语（你好、hi、hello、嘿等）
- load_resume: 加载简历（包含"加载简历"、"导入简历"等）
- unknown: 其他所有情况（交给 LLM 根据上下文处理）

## 输出格式（JSON）
{{
    "intent": "greeting/load_resume/unknown",
    "confidence": 0.0-1.0,
    "reasoning": "简短理由"
}}

只返回JSON。"""
```

### 简化的系统提示词 (app/prompt/manus.py)

```python
SYSTEM_PROMPT = """You are OpenManus, an AI assistant for resume optimization.

## Core Principles

1. **Resume-related tasks** → Use appropriate tools
2. **General questions** → Answer directly using your knowledge, NO tools
3. **Understand context** → Consider conversation history and resume state

## Available Tools

| Tool | When to Use |
|------|-------------|
| cv_reader_agent | Load resume from file path |
| cv_analyzer_agent | Analyze resume quality and content |
| education_analyzer | Analyze education background specifically |
| cv_editor_agent | Edit resume content |
| terminate | Complete the task |

## Guidelines

- **DO** use tools for resume operations
- **DO NOT** use browser/search tools for general knowledge
- **DO** answer common questions directly
- Working language: Chinese
"""
```

## 与 LangChain 的对比

### 当前设计 vs LangChain 纯方案

| 特性 | LangChain 纯方案 | 当前设计 |
|------|-----------------|----------|
| **意图识别** | 无 | 仅特殊意图 (GREETING, LOAD_RESUME) |
| **工具选择** | 完全由 LLM 决定 | LLM 决定 + 代码层优化 |
| **性能** | 标准 | LOAD_RESUME 跳过重复检查 |
| **扩展性** | 高 | 高（添加工具无需修改意图） |
| **常识处理** | 依赖 LLM | 显式提示 LLM 直接回答 |

### 设计权衡

**保留的显式处理**:
- `GREETING`: 统一问候体验
- `LOAD_RESUME`: 防止重复加载简历

**交给 LLM 的判断**:
- 选择哪个分析工具
- 是否需要编辑
- 是否常识问题
- 所有其他场景

## 优化准则

### 添加新工具

```python
# 1. 创建工具类
class NewTool(BaseTool):
    name = "new_tool"
    description = """清晰描述工具用途和何时使用"""
    parameters = {...}

# 2. 添加到 available_tools
available_tools.add_tools(NewTool())

# 3. 完成！无需修改意图枚举
```

### 添加新的特殊意图（谨慎）

只有在以下情况才考虑添加新的意图类型：

1. **必须在代码层面拦截**的场景
   - 例如：防止重复操作
   - 例如：特殊的性能优化

2. **LLM 无法正确处理的场景**
   - 例如：复杂的流程控制
   - 例如：多步骤的状态同步

**添加步骤**：
```python
# 1. 在 Intent 枚举中添加
class Intent(str, Enum):
    GREETING = "greeting"
    LOAD_RESUME = "load_resume"
    NEW_SPECIAL_CASE = "new_case"  # 新增
    UNKNOWN = "unknown"

# 2. 在意图识别提示词中添加说明
# 3. 在 should_use_tool_directly() 中添加逻辑
# 4. 在 think() 中添加处理逻辑
```

### 工具描述编写指南

好的工具描述是 LLM 正确决策的关键：

```python
# ✅ 好的描述
description = """Analyze resume education background specifically.
Use this when user asks about education, degrees, schools, or academic qualifications."""

# ❌ 不好的描述
description = "Education tool"  # 太简单
```

**原则**:
1. **明确用途**: 清楚说明工具做什么
2. **使用场景**: 说明何时使用这个工具
3. **关键词**: 包含用户可能使用的关键词

## 相关文件

| 文件 | 说明 |
|------|------|
| `app/agent/manus.py` | Manus Agent，集成意图识别 |
| `app/memory/conversation_state.py` | 意图识别和状态管理 |
| `app/prompt/manus.py` | 系统提示词 |
| `app/tool/*.py` | 各工具的实现和描述 |

## 总结

当前设计采用**最小化意图 + LLM 自主决策**的方案：

1. ✅ **简洁**: 仅 3 个意图类型
2. ✅ **灵活**: LLM 根据工具描述自主决策
3. ✅ **可扩展**: 添加工具无需修改意图
4. ✅ **性能优化**: 特殊场景代码层处理
5. ✅ **常识处理**: LLM 直接回答常识问题

这种设计在保持控制性的同时，最大程度地发挥了 LLM 的理解能力。
