# 上下文传递修复记录

**修复日期**: 2026-01-06
**修复人**: Claude (AI Assistant)
**问题类型**: 会话上下文丢失导致优化流程失败

---

## 问题描述

### 症状
用户进行"分析教育经历" → "优化"的两步操作时，第二步无法正常工作：

1. **第一轮**：用户说 "帮我分析教育经历"
   - 调用 `cv_reader_agent` → `education_analyzer`
   - 分析结果包含优化建议 JSON (`optimization_suggestions`)
   - ✅ 正常完成

2. **第二轮**：用户说 "优化"
   - 预期：从第一轮的分析结果中提取优化建议，调用 `cv_editor_agent` 修改简历
   - 实际：Agent 无法找到之前的分析结果，`cv_editor_agent` 未被调用
   - ❌ 失败

### 根本原因
**Tool 消息没有被保存到 ChatHistory**，导致 Agent 在新连接或新对话轮次中无法获取之前的工具调用结果。

原有的 ChatHistory 只保存 `user` 和 `assistant` 消息，而 `tool` 类型的消息（包含关键的优化建议 JSON）被完全跳过。

---

## 解决方案

### 方案概述
**完整保存和恢复所有类型的对话消息**，包括 Tool 消息和带有 tool_calls 的 Assistant 消息。

### 架构变更

#### 1. 消息类型扩展
在 LangChain 风格的消息系统中新增 `ToolMessage` 类型：

- **位置**: `app/memory/langchain/messages/__init__.py`
- **新增**: `ToolMessage` 类
- **用途**: 专门表示工具执行结果，携带 `tool_call_id` 和 `name` 元数据

#### 2. 消息转换器更新
更新 `MessageAdapter` 以支持 Tool 消息的双向转换：

- **位置**: `app/memory/message_adapter.py`
- **变更**: `to_langchain()` 和 `from_langchain()` 方法
- **能力**:
  - OpenManus Tool Message → LangChain ToolMessage（保存时）
  - LangChain ToolMessage → OpenManus Tool Message（恢复时）

#### 3. 服务器端点更新
在 WebSocket 端点中实现完整的消息保存和恢复逻辑：

- **位置**: `app/web/server.py`

**保存逻辑**（在消息生成时）：
1. 保存 Assistant 思考消息
2. 保存 Assistant 消息（带 tool_calls）
3. 保存 Tool 消息（包含优化建议 JSON）
4. 保存最终答案

**恢复逻辑**（在新连接建立时）：
1. 从 ChatHistory 获取所有历史消息
2. 根据 role 类型分发：
   - `user` → 恢复为用户消息
   - `assistant` → 恢复为助手消息（保留 tool_calls）
   - `tool` → 恢复为工具消息（保留 name 和 tool_call_id）

---

## 数据流图

### 修复前
```
用户 "分析教育经历"
    ↓
education_analyzer 返回 JSON 结果
    ↓
[❌ Tool 消息丢失]
    ↓
ChatHistory 只有 user + assistant 消息
    ↓
用户 "优化"
    ↓
Agent 检查 memory.messages，找不到 tool 结果
    ↓
无法调用 cv_editor_agent
```

### 修复后
```
用户 "分析教育经历"
    ↓
education_analyzer 返回 JSON 结果
    ↓
[✅ Tool 消息保存到 ChatHistory]
    ↓
ChatHistory 包含 user + assistant + tool 消息
    ↓
用户 "优化"
    ↓
Agent 从 ChatHistory 恢复 tool 消息到 memory
    ↓
检查到 education_analyzer 结果，提取 optimization_suggestions
    ↓
成功调用 cv_editor_agent 修改简历
```

---

## 测试验证

### 测试脚本
创建了 `test_context_preservation.py` 进行两轮测试：

1. **第一轮**：发送 "帮我分析教育经历"
   - 验证：Tool 消息包含 `optimization_suggestions` JSON
   - 预期：✅ 成功

2. **第二轮**：发送 "优化"
   - 验证：`cv_editor_agent` 被调用
   - 预期：✅ 成功

### 测试结果
```
============================================================
 🎉 上下文传递测试通过！
 - 第一轮: Tool 消息被正确保存到 ChatHistory
 - 第二轮: 从 ChatHistory 恢复 Tool 消息，成功调用编辑工具
============================================================
```

---

## 影响范围

### 受益功能
1. **教育经历优化流程**：分析 → 优化
2. **简历全部分析流程**：分析简历 → 应用建议
3. **所有多轮对话场景**：Agent 现在可以记住之前的工具调用结果

### 向后兼容性
- ✅ 完全兼容
- 现有的 `user` 和 `assistant` 消息处理逻辑保持不变
- 新增的 `tool` 消息处理是增量式添加

---

## 关键文件变更

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `app/memory/langchain/messages/__init__.py` | 新增 | ToolMessage 类 |
| `app/memory/langchain/__init__.py` | 修改 | 导出 ToolMessage |
| `app/memory/message_adapter.py` | 修改 | 支持 Tool 消息转换 |
| `app/web/server.py` | 修改 | 保存/恢复 Tool 消息 |
| `app/schema.py` | 无变更 | Role 枚举已包含 TOOL |

---

## 后续优化建议

1. **消息大小控制**：Tool 消息可能很大（如 5000 字符），考虑添加摘要机制
2. **会话隔离**：当前所有连接共享全局 ChatHistory，多用户场景需引入 session_id
3. **持久化存储**：ChatHistory 目前只在内存中，服务重启会丢失
4. **清理策略**：添加旧消息的自动清理机制，避免内存无限增长

---

**文档版本**: 1.0
**最后更新**: 2026-01-06
