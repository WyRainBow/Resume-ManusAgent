# å¤š Agent åä½œä¸ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ OpenManus ç®€å†ä¼˜åŒ–ç³»ç»Ÿå¦‚ä½•å®ç°ï¼š
1. **é¿å…å¤š Agent é‡å¤åŠ è½½ç®€å†**
2. **åœ¨ Agent ä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡**
3. **å®ç°å¤šè½®å¯¹è¯**

---

## 2. é¿å…å¤š Agent é‡å¤åŠ è½½ç®€å†

### 2.1 æ ¸å¿ƒæœºåˆ¶ï¼šå…¨å±€ç®€å†æ•°æ®å­˜å‚¨

ç³»ç»Ÿä½¿ç”¨ä¸€ä¸ª**å…¨å±€å•ä¾‹å­˜å‚¨** (`ResumeDataStore`) æ¥é¿å…é‡å¤åŠ è½½ç®€å†ï¼š

```python
# app/tool/resume_data_store.py
class ResumeDataStore:
    """å…±äº«çš„ç®€å†æ•°æ®å­˜å‚¨"""

    _data: Optional[dict] = None

    @classmethod
    def set_data(cls, resume_data: dict):
        """è®¾ç½®ç®€å†æ•°æ®"""
        cls._data = resume_data

    @classmethod
    def get_data(cls) -> Optional[dict]:
        """è·å–ç®€å†æ•°æ®"""
        return cls._data
```

### 2.2 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·è¯·æ±‚                                 â”‚
â”‚        "å¸®æˆ‘åˆ†æç®€å†"                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Manus Agent                                 â”‚
â”‚  è¯†åˆ«æ„å›¾ â†’ éœ€è¦ç®€å†æ•°æ® â†’ è°ƒç”¨ cv_reader_agent å·¥å…·             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CVReaderAgentTool                              â”‚
â”‚  æ‰§è¡Œ execute() â†’ ResumeDataStore.get_data()                    â”‚
â”‚                                                                 â”‚
â”‚  å¦‚æœæœ‰æ•°æ® â†’ ç›´æ¥è¿”å›                                            â”‚
â”‚  å¦‚æœæ— æ•°æ® â†’ ä»æ–‡ä»¶åŠ è½½å¹¶å­˜å‚¨åˆ° ResumeDataStore                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ResumeDataStore (å…¨å±€å•ä¾‹)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ _data: {                                                â”‚    â”‚
â”‚  â”‚   "raw_content": "...",                                 â”‚    â”‚
â”‚  â”‚   "sections": [...]                                     â”‚    â”‚
â”‚  â”‚ }                                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Analyzer â”‚      â”‚Optimizer â”‚      â”‚  Editor  â”‚
    â”‚  Agent   â”‚      â”‚  Agent   â”‚      â”‚  Agent   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  éƒ½ä» ResumeDataStore è·å–æ•°æ®
                  æ— éœ€é‡å¤åŠ è½½ï¼
```

### 2.3 æ‰€æœ‰ Agent å·¥å…·å…±äº«æ•°æ®

æ‰€æœ‰ç®€å†ç›¸å…³çš„ Agent å·¥å…·éƒ½é€šè¿‡ `ResumeDataStore` è·å–æ•°æ®ï¼š

```python
# CVReaderAgentTool
class CVReaderAgentTool(BaseTool):
    @classmethod
    def set_resume_data(cls, resume_data: dict):
        ResumeDataStore.set_data(resume_data)

    async def execute(self, section: str = "all", ...):
        resume_data = ResumeDataStore.get_data()
        # ç›´æ¥ä½¿ç”¨æ•°æ®ï¼Œä¸é‡å¤åŠ è½½

# CVAnalyzerAgentTool
class CVAnalyzerAgentTool(BaseTool):
    async def execute(self, question: str):
        resume_data = ResumeDataStore.get_data()
        # ä½¿ç”¨å…±äº«çš„ç®€å†æ•°æ®è¿›è¡Œåˆ†æ

# CVOptimizerAgentTool, CVEditorAgentTool ... åŒæ ·æœºåˆ¶
```

### 2.4 åç«¯åŒæ­¥å…¨å±€æ•°æ®

åœ¨ FastAPI æœåŠ¡å™¨ä¸­ï¼Œå½“ç®€å†æ•°æ®æ›´æ–°æ—¶ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰å·¥å…·ï¼š

```python
# app/web/server.py
_global_resume_data = {}

async def set_resume_data(data: dict):
    global _global_resume_data
    _global_resume_data = data

    # åŒæ­¥åˆ°æ‰€æœ‰ Agent å·¥å…·
    CVReaderAgentTool.set_resume_data(_global_resume_data)
    CVAnalyzerAgentTool.set_resume_data(_global_resume_data)
    CVOptimizerAgentTool.set_resume_data(_global_resume_data)
    CVEditorAgentTool.set_resume_data(_global_resume_data)
```

---

## 3. ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶

### 3.1 ä¸‰å±‚ä¸Šä¸‹æ–‡ä¼ é€’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å±‚çº§ç»“æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: ChatHistoryManager (å…¨å±€å¯¹è¯å†å²)                      â”‚
â”‚           â””â”€â”€ è·¨è¿æ¥ã€è·¨è¯·æ±‚æŒä¹…åŒ–                                 â”‚
â”‚                                                                 â”‚
â”‚  Layer 2: Manus Agent Memory (Agent å†…éƒ¨è®°å¿†)                    â”‚
â”‚           â””â”€â”€ å½“å‰è¿æ¥çš„å¯¹è¯ä¸Šä¸‹æ–‡                                â”‚
â”‚                                                                 â”‚
â”‚  Layer 3: ResumeDataStore (å…¨å±€ç®€å†æ•°æ®)                         â”‚
â”‚           â””â”€â”€ æ‰€æœ‰ Agent å…±äº«çš„ç®€å†å†…å®¹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 WebSocket è¿æ¥æ—¶çš„ä¸Šä¸‹æ–‡æ¢å¤

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()

    # åˆ›å»º Manus Agent
    agent = await Manus.create()

    # è·å–å…¨å±€ ChatHistory
    global_chat_history = get_chat_history_sync()
    agent._chat_history = global_chat_history

    # æ¢å¤å†å²æ¶ˆæ¯åˆ° agent.memory
    existing_messages = global_chat_history.get_messages()
    if existing_messages:
        logger.info(f"ğŸ“œ æ¢å¤ {len(existing_messages)} æ¡å†å²æ¶ˆæ¯")
        for msg in existing_messages:
            if msg.role.value == "user":
                agent.memory.add_message(Message.user_message(msg.content))
            elif msg.role.value == "assistant":
                agent.memory.add_message(Message.assistant_message(msg.content))
```

### 3.3 æ¶ˆæ¯æµè½¬è¿‡ç¨‹

```
ç”¨æˆ·: "å¸®æˆ‘åˆ†æç®€å†"
    â”‚
    â”œâ”€â–º [ä¿å­˜åˆ° ChatHistory] â”€â”€â–º å…¨å±€æŒä¹…åŒ–
    â”‚
    â”œâ”€â–º [æ·»åŠ åˆ° agent.memory] â”€â”€â–º å½“å‰ Agent ä¸Šä¸‹æ–‡
    â”‚
    â””â”€â–º [Manus å¤„ç†]
          â”‚
          â”œâ”€â–º æ„å›¾è¯†åˆ«: ANALYZE
          â”‚
          â”œâ”€â–º è°ƒç”¨ cv_analyzer_agent å·¥å…·
          â”‚     â”‚
          â”‚     â””â”€â–º [ä» ResumeDataStore è·å–ç®€å†æ•°æ®]
          â”‚           â”‚
          â”‚           â””â”€â–º æ‰§è¡Œåˆ†æ
          â”‚
          â””â”€â–º ç”Ÿæˆå›å¤
                â”‚
                â”œâ”€â–º [ä¿å­˜åˆ° ChatHistory] â”€â”€â–º å…¨å±€æŒä¹…åŒ–
                â”‚
                â””â”€â–º [WebSocket å‘é€ç»™ç”¨æˆ·]

ç”¨æˆ·: "å·¥ä½œç»å†æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ" (ä¸Šä¸‹æ–‡ä¿æŒ)
    â”‚
    â”œâ”€â–º [ä¿å­˜åˆ° ChatHistory]
    â”‚
    â”œâ”€â–º [æ·»åŠ åˆ° agent.memory] â”€â”€â–º åŒ…å«ä¹‹å‰çš„å¯¹è¯
    â”‚
    â””â”€â–º [Manus å¤„ç†]
          â”‚
          â”œâ”€â–º æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡: "å·¥ä½œç»å†" + ä¹‹å‰çš„"åˆ†æç®€å†"
          â”‚
          â””â”€â–º åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå›å¤ (æ— éœ€é‡æ–°åŠ è½½ç®€å†)
```

### 3.4 ä¸Šä¸‹æ–‡ä½¿ç”¨æ£€æµ‹

ç³»ç»Ÿä¼šæ£€æµ‹ AI æ˜¯å¦ä½¿ç”¨äº†å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå¹¶å‘å‰ç«¯å‘é€æç¤ºï¼š

```python
def _detect_context_usage(current_content: str, previous_messages: list) -> str:
    """æ£€æµ‹ AI æ˜¯å¦ä½¿ç”¨äº†ä¸Šä¸‹æ–‡ä¿¡æ¯"""

    # 1. æ£€æµ‹ä¸Šä¸‹æ–‡å…³é”®è¯
    context_keywords = ["æ ¹æ®", "åŸºäº", "ä¹‹å‰", "åˆšæ‰", "ä¹‹å‰æåˆ°", ...]

    # 2. æŸ¥æ‰¾æœ€è¿‘çš„ç”¨æˆ·è¯·æ±‚
    user_requests = [...]

    # 3. æŸ¥æ‰¾æœ€è¿‘çš„ AI åˆ†æ
    ai_responses = [...]

    # 4. ç”Ÿæˆä¸Šä¸‹æ–‡æç¤º
    if context_summary:
        return f"æ ¹æ®ä¹‹å‰çš„å¯¹è¯ï¼Œæˆ‘äº†è§£åˆ°ï¼š\n\n{context_summary}"
```

---

## 4. å¤šè½®å¯¹è¯å®ç°

### 4.1 å…³é”®è®¾è®¡å†³ç­–

```python
# é‡è¦ï¼šä¸æ¸…ç©ºè®°å¿†ï¼Œä¿æŒå¤šè½®å¯¹è¯
# agent.memory.messages.clear()  # å·²ç§»é™¤ï¼šæ”¯æŒå¤šè½®å¯¹è¯
```

### 4.2 å¤šè½®å¯¹è¯ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¬¬ä¸€è½®å¯¹è¯                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·: "åŠ è½½æˆ‘çš„ç®€å†"                                            â”‚
â”‚  AI:   "å·²åŠ è½½ç®€å†ï¼ŒåŒ…å«ä»¥ä¸‹æ¨¡å—..."                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¬¬äºŒè½®å¯¹è¯ (ä¸Šä¸‹æ–‡ä¿æŒ)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·: "åˆ†æä¸€ä¸‹å·¥ä½œç»å†"  â† æ— éœ€é‡å¤åŠ è½½ç®€å†                     â”‚
â”‚  AI:   "æ ¹æ®ä½ çš„ç®€å†ï¼Œå·¥ä½œç»å†æœ‰ä»¥ä¸‹ç‰¹ç‚¹..."                     â”‚
â”‚        (AI çŸ¥é“ç”¨æˆ·å·²ç»åŠ è½½äº†ç®€å†)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¬¬ä¸‰è½®å¯¹è¯ (ä¸Šä¸‹æ–‡ä¿æŒ)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·: "æ€ä¹ˆä¼˜åŒ–ï¼Ÿ"        â† åŸºäºä¹‹å‰çš„åˆ†æ                       â”‚
â”‚  AI:   "é’ˆå¯¹ä½ å·¥ä½œç»å†çš„é—®é¢˜ï¼Œå»ºè®®..."                           â”‚
â”‚        (AI çŸ¥é“ä¹‹å‰åˆ†æçš„ç»“æœ)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å¤šè½®å¯¹è¯ä¸­çš„çŠ¶æ€ç®¡ç†

```python
# æ¯æ¬¡æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯æ—¶
while True:
    data = await websocket.receive_text()
    prompt = message.get("prompt", "")

    # 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° ChatHistory
    global_chat_history.add_message(Message(role=Role.USER, content=prompt))

    # 2. æ·»åŠ åˆ° Agent è®°å¿† (ä¸æ¸…ç©ºä¹‹å‰çš„)
    agent.memory.add_message(Message.user_message(prompt))

    # 3. Agent å¤„ç† (å¸¦ç€å®Œæ•´ä¸Šä¸‹æ–‡)
    results = await agent.run(prompt)

    # 4. ä¿å­˜ AI å›å¤åˆ° ChatHistory
    global_chat_history.add_message(Message(role=Role.ASSISTANT, content=final_answer))
```

### 4.4 è¿æ¥é‡è¿åçš„ä¸Šä¸‹æ–‡æ¢å¤

```
ç”¨æˆ·åˆ·æ–°é¡µé¢ / é‡æ–°è¿æ¥
    â”‚
    â–¼
WebSocket è¿æ¥å»ºç«‹
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¢å¤æµç¨‹:                                                       â”‚
â”‚                                                                 â”‚
â”‚  1. è·å–å…¨å±€ ChatHistory                                        â”‚
â”‚     global_chat_history = get_chat_history_sync()              â”‚
â”‚                                                                 â”‚
â”‚  2. åŒæ­¥ç»™æ–° Agent                                              â”‚
â”‚     agent._chat_history = global_chat_history                  â”‚
â”‚                                                                 â”‚
â”‚  3. æ¢å¤å†å²æ¶ˆæ¯åˆ° agent.memory                                 â”‚
â”‚     for msg in global_chat_history.get_messages():             â”‚
â”‚         agent.memory.add_message(msg)                          â”‚
â”‚                                                                 â”‚
â”‚  4. ç”¨æˆ·ç»§ç»­å¯¹è¯ï¼Œä¸Šä¸‹æ–‡å®Œæ•´ä¿æŒ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®Œæ•´æ•°æ®æµç¤ºä¾‹

### 5.1 åœºæ™¯ï¼šç”¨æˆ·åˆ†æç®€å†åä¼˜åŒ–å·¥ä½œç»å†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: ç”¨æˆ·å‘é€ "åŠ è½½æˆ‘çš„ç®€å† resume.md"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â–º WebSocket: {"prompt": "åŠ è½½æˆ‘çš„ç®€å† resume.md"}
    â”‚
    â”œâ”€â–º ä¿å­˜åˆ° ChatHistory: {role: "user", content: "åŠ è½½æˆ‘çš„ç®€å† resume.md"}
    â”‚
    â”œâ”€â–º Manus è¯†åˆ«æ„å›¾: LOAD_RESUME
    â”‚
    â”œâ”€â–º è°ƒç”¨ cv_reader_agent(file_path="resume.md")
    â”‚     â”‚
    â”‚     â””â”€â–º ResumeDataStore.set_data(parsed_resume)  â† å­˜å‚¨ç®€å†
    â”‚
    â””â”€â–º è¿”å›: "å·²æˆåŠŸåŠ è½½ç®€å†ï¼ŒåŒ…å«å·¥ä½œç»å†ã€é¡¹ç›®ç»éªŒç­‰æ¨¡å—"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: ç”¨æˆ·å‘é€ "åˆ†æä¸€ä¸‹æˆ‘çš„ç®€å†"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â–º WebSocket: {"prompt": "åˆ†æä¸€ä¸‹æˆ‘çš„ç®€å†"}
    â”‚
    â”œâ”€â–º ä¿å­˜åˆ° ChatHistory: {role: "user", content: "åˆ†æä¸€ä¸‹æˆ‘çš„ç®€å†"}
    â”‚
    â”œâ”€â–º Manus è¯†åˆ«æ„å›¾: ANALYZE
    â”‚
    â”œâ”€â–º è°ƒç”¨ cv_analyzer_agent(question="åˆ†æä¸€ä¸‹æˆ‘çš„ç®€å†")
    â”‚     â”‚
    â”‚     â””â”€â–º ResumeDataStore.get_data()  â† è·å–å·²å­˜å‚¨çš„ç®€å† (ä¸é‡æ–°åŠ è½½!)
    â”‚           â”‚
    â”‚           â””â”€â–º æ‰§è¡Œåˆ†æï¼Œè¿”å›ç»“æœ
    â”‚
    â””â”€â–º è¿”å›: "ä½ çš„ç®€å†æœ‰ä»¥ä¸‹é—®é¢˜ï¼šå·¥ä½œç»å†ç¼ºå°‘é‡åŒ–æŒ‡æ ‡..."
          â”‚
          â””â”€â–º ä¿å­˜åˆ° ChatHistory

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: ç”¨æˆ·å‘é€ "å¸®æˆ‘ä¼˜åŒ–å·¥ä½œç»å†" (åŸºäºä¸Šä¸‹æ–‡)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â–º WebSocket: {"prompt": "å¸®æˆ‘ä¼˜åŒ–å·¥ä½œç»å†"}
    â”‚
    â”œâ”€â–º ä¿å­˜åˆ° ChatHistory
    â”‚
    â”œâ”€â–º Manus è¯†åˆ«æ„å›¾: OPTIMIZE_SECTION
    â”‚
    â”œâ”€â–º æ£€æµ‹ä¸Šä¸‹æ–‡: çŸ¥é“ç”¨æˆ·åˆšåˆšåˆ†æäº†ç®€å†
    â”‚
    â”œâ”€â–º è°ƒç”¨ cv_optimizer_agent(section="experience")
    â”‚     â”‚
    â”‚     â””â”€â–º ResumeDataStore.get_data()  â† è·å–å·²å­˜å‚¨çš„ç®€å†
    â”‚           â”‚
    â”‚           â””â”€â–º åŸºäºä¹‹å‰çš„åˆ†æç»“æœä¼˜åŒ–
    â”‚
    â””â”€â–º è¿”å›: "é’ˆå¯¹ä½ å·¥ä½œç»å†ç¼ºå°‘é‡åŒ–æŒ‡æ ‡çš„é—®é¢˜ï¼Œå»ºè®®æ”¹ä¸º..."
          â”‚
          â””â”€â–º ä¿å­˜åˆ° ChatHistory
```

---

## 6. æ¶æ„ä¼˜åŠ¿

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|----------|------|
| **é¿å…é‡å¤åŠ è½½** | ResumeDataStore å…¨å±€å•ä¾‹ | ç®€å†åªåŠ è½½ä¸€æ¬¡ï¼Œæ‰€æœ‰ Agent å…±äº« |
| **ä¸Šä¸‹æ–‡ä¿æŒ** | ChatHistoryManager + Agent Memory | å¤šè½®å¯¹è¯è¿è´¯ï¼Œæ— éœ€é‡å¤æè¿°èƒŒæ™¯ |
| **çŠ¶æ€æ¢å¤** | è¿æ¥æ—¶æ¢å¤å†å²æ¶ˆæ¯ | åˆ·æ–°é¡µé¢åå¯¹è¯ç»§ç»­ |
| **æ•°æ®ä¸€è‡´æ€§** | æ‰€æœ‰å·¥å…·ä»åŒä¸€æºå¤´è·å–æ•°æ® | å„ Agent çœ‹åˆ°çš„ç®€å†æ•°æ®å®Œå…¨ä¸€è‡´ |
| **æ‰©å±•æ€§** | å·¥å…·é€šè¿‡ classmethod è®¿é—®æ•°æ® | æ–°å¢ Agent å·¥å…·åªéœ€è°ƒç”¨ç›¸åŒçš„ API |

---

## 7. å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `app/tool/resume_data_store.py` | å…¨å±€ç®€å†æ•°æ®å­˜å‚¨ |
| `app/tool/cv_reader_agent_tool.py` | CVReader å·¥å…· |
| `app/tool/cv_analyzer_agent_tool.py` | CVAnalyzer å·¥å…· |
| `app/tool/cv_optimizer_agent_tool.py` | CVOptimizer å·¥å…· |
| `app/tool/cv_editor_agent_tool.py` | CVEditor å·¥å…· |
| `app/web/server.py` | WebSocket ç«¯ç‚¹ï¼Œå…¨å±€çŠ¶æ€ç®¡ç† |
| `app/memory/chat_history_manager.py` | å¯¹è¯å†å²ç®¡ç† |
