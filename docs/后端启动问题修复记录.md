# 后端启动问题修复记录

## 问题描述

在使用 `conda run -n openmanus` 在后台启动后端服务时，发现服务无法正常启动。问题表现为：
- 后端进程启动后立即退出
- 健康检查失败
- 日志中可能显示 Python 找不到项目依赖或模块导入错误

## 问题原因分析

### 原始启动方式
```bash
conda run -n openmanus python -m uvicorn app.web.server:app --host 0.0.0.0 --port 8000 --reload > log 2>&1 &
```

**问题根源**：
1. `conda run` 在后台子进程中执行时，环境变量和路径没有正确继承
2. 后台进程（`&`）中，conda 的 shell hook 没有被正确初始化
3. Python 解释器无法找到项目依赖，导致模块导入失败

### 技术细节
- `conda run` 是一个包装命令，但在后台执行时可能无法正确设置环境
- 后台进程（`&`）不会继承交互式 shell 的 conda 初始化
- 需要显式初始化 conda 的 bash hook 才能正确激活环境

## 解决方案

### 修复后的启动方式
```bash
bash -c "eval \"\$(conda shell.bash hook)\" && conda activate openmanus && python -m uvicorn app.web.server:app --host 0.0.0.0 --port 8000 --reload" > log 2>&1 &
```

### 关键改进点

1. **使用 `bash -c` 执行命令**
   - 确保命令在独立的 bash 子进程中执行
   - 可以正确初始化 conda 环境

2. **显式初始化 conda shell hook**
   ```bash
   eval "$(conda shell.bash hook)"
   ```
   - 初始化 conda 的 bash 函数
   - 使 `conda activate` 命令可用

3. **使用 `conda activate` 而不是 `conda run`**
   - `conda activate` 在已初始化的 shell 中更可靠
   - 确保环境变量和路径正确设置

4. **使用 `&&` 确保顺序执行**
   - 每个步骤必须成功才能继续
   - 如果任何步骤失败，整个命令会终止

## 当前启动流程

### 完整启动命令（来自 `tests/start.sh`）
```bash
# 创建日志目录
mkdir -p "$PROJECT_ROOT/logs"

# 启动后端服务
cd "$PROJECT_ROOT"
bash -c "eval \"\$(conda shell.bash hook)\" && conda activate openmanus && python -m uvicorn app.web.server:app --host 0.0.0.0 --port 8000 --reload" > "$PROJECT_ROOT/logs/backend.log" 2>&1 &
BACKEND_PID=$!

# 健康检查（循环重试）
for i in {1..15}; do
    if curl -s http://localhost:8000/api/health > /dev/null 2>&1; then
        echo "✅ 后端服务启动成功"
        break
    fi
    if [ $i -eq 15 ]; then
        echo "❌ 后端服务启动失败"
        exit 1
    fi
    sleep 1
done
```

### 健康检查改进

**原始方式**：
```bash
sleep 8
if curl -s http://localhost:8000/api/health > /dev/null 2>&1; then
    echo "✅ 后端服务启动成功"
else
    echo "❌ 后端服务启动失败"
    exit 1
fi
```

**改进后**：
```bash
for i in {1..15}; do
    if curl -s http://localhost:8000/api/health > /dev/null 2>&1; then
        echo "✅ 后端服务启动成功"
        break
    fi
    if [ $i -eq 15 ]; then
        echo "❌ 后端服务启动失败"
        exit 1
    fi
    sleep 1
done
```

**优势**：
- 循环重试最多 15 次，每次间隔 1 秒
- 如果服务快速启动，可以立即检测到
- 如果服务启动较慢，有足够时间等待
- 避免固定等待时间过长或过短的问题

## 手动启动方式

如果需要手动启动后端服务，可以使用以下命令：

```bash
# 方式 1：使用修复后的命令
cd /Users/wy770/Resume_OpenMauns/OpenManus
bash -c "eval \"\$(conda shell.bash hook)\" && conda activate openmanus && python -m uvicorn app.web.server:app --host 0.0.0.0 --port 8000 --reload"

# 方式 2：先激活环境再启动（交互式终端）
conda activate openmanus
cd /Users/wy770/Resume_OpenMauns/OpenManus
python -m uvicorn app.web.server:app --host 0.0.0.0 --port 8000 --reload

# 方式 3：使用启动脚本
./tests/start.sh
```

## 验证方法

启动后可以通过以下方式验证：

```bash
# 1. 检查进程
ps aux | grep uvicorn

# 2. 检查端口
lsof -ti:8000

# 3. 健康检查
curl http://localhost:8000/api/health

# 4. 查看日志
tail -f logs/backend.log
```

## 总结

- **问题**：`conda run` 在后台执行时环境变量未正确继承
- **解决**：使用 `bash -c` + `conda shell.bash hook` + `conda activate`
- **改进**：健康检查改为循环重试，更灵活可靠
- **结果**：后端服务可以稳定启动，环境变量和依赖正确加载
