# åŠ è½½ç®€å†åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

ç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥ `åŠ è½½æˆ‘çš„ç®€å†/path/to/resume.md` æ¥åŠ è½½ç®€å†æ–‡ä»¶ã€‚æœ¬æ–‡æ¡£æè¿°äº†ä»å‰ç«¯åˆ°åç«¯çš„å®Œæ•´æ•°æ®æµã€‚

## å‰ç«¯è·¯å¾„æå–

**æ–‡ä»¶**: `frontend/src/App.jsx`

```javascript
const extractResumePath = (input) => {
    // åŒ¹é…å¤šç§æ ¼å¼ï¼Œä¿ç•™å¼€å¤´çš„ /
    const patterns = [
      /ç®€å†(?:[\/\s]+)(\/[^\s]+\.(?:md|txt|MD|TXT))/,  // ç®€å†//è·¯å¾„.md
      /(?:åŠ è½½|å¯¼å…¥|ä¸Šä¼ )(?:æˆ‘çš„)?ç®€å†[\/\s]+(\/[^\s]+\.(?:md|txt|MD|TXT))/,  // åŠ è½½æˆ‘çš„ç®€å†//è·¯å¾„.md
      /(\/[^\s]+\.(?:md|txt))/  // ä»»ä½• /path/to/file.md
    ];

    for (const pattern of patterns) {
      const match = input.match(pattern);
      if (match) {
        return match[1];  // è¿”å›ä»¥ / å¼€å¤´çš„ç»å¯¹è·¯å¾„
      }
    }
    return null;
};
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ `(\/...)` ç¡®ä¿åŒ¹é…çš„è·¯å¾„ä»¥ `/` å¼€å¤´
- åªåŒ¹é… `.md` æˆ– `.txt` æ–‡ä»¶
- æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼

## å‰ç«¯ WebSocket å‘é€

**æ–‡ä»¶**: `frontend/src/App.jsx`

```javascript
const handleSubmit = (e) => {
    // ...

    // æå–ç®€å†è·¯å¾„
    const resumePath = extractResumePath(input.trim());

    // å‘é€è¯·æ±‚
    const message = resumePath
        ? { prompt: input.trim(), resume_path: resumePath }  // æœ‰è·¯å¾„æ—¶å¸¦ä¸Š resume_path
        : { prompt: input.trim() };                        // æ— è·¯å¾„æ—¶åªå‘é€ prompt

    currentWs.send(JSON.stringify(message));
};
```

**å‘é€çš„ JSON æ ¼å¼**:
```json
{
    "prompt": "åŠ è½½æˆ‘çš„ç®€å†/Users/wy770/Resume_OpenMauns/OpenManus/app/docs/éŸ¦å®‡_ç®€å†.md",
    "resume_path": "/Users/wy770/Resume_OpenMauns/OpenManus/app/docs/éŸ¦å®‡_ç®€å†.md"
}
```

## åç«¯æ¥æ”¶å¤„ç†

**æ–‡ä»¶**: `app/web/server.py`

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    # ...
    message = json.loads(data)
    message_type = message.get("type", "prompt")
    prompt = message.get("prompt", "")

    # æ¥æ”¶ resume_pathï¼ˆæ”¯æŒ cv_path å’Œ resume_path ä¸¤ç§é”®åï¼‰
    resume_path = message.get("cv_path") or message.get("resume_path")

    # åˆ›å»º session æ—¶ä¼ å…¥ cv_path
    session = await session_manager.get_or_create_session(
        client_id,
        cv_path=resume_path,  # ä¼ é€’ç®€å†è·¯å¾„
    )

    # è®¾ç½® agent çš„ _current_resume_path
    if resume_path:
        session.agent._current_resume_path = resume_path
        logger.info(f"ğŸ“„ è®¾ç½®å½“å‰ç®€å†è·¯å¾„: {resume_path}")
```

## æ„å›¾è¯†åˆ«

**æ–‡ä»¶**: `app/memory/conversation_state.py`

```python
async def classify_intent_with_llm(self, user_input: str, ...):
    # LLM è¯†åˆ«æ„å›¾ä¸º load_resume
    # è¿”å›:
    return {
        "intent": Intent.LOAD_RESUME,
        "tool": "cv_reader_agent",
        "tool_args": {},  # æ³¨æ„ï¼šå½“å‰ä¸æå– file_path
    }
```

## ç›´æ¥å·¥å…·è°ƒç”¨

**æ–‡ä»¶**: `app/agent/manus.py`

```python
async def _handle_direct_tool_call(
    self,
    tool: str,
    tool_args: dict,
    intent: "Intent"
) -> bool:
    # ğŸš¨ ç‰¹æ®Šå¤„ç†ï¼šcv_reader_agent éœ€è¦æ–‡ä»¶è·¯å¾„
    # å¦‚æœ tool_args ä¸ºç©ºä½†æœ‰ _current_resume_pathï¼Œä½¿ç”¨å®ƒ
    if tool == "cv_reader_agent" and not tool_args.get("file_path"):
        if self._current_resume_path:
            tool_args["file_path"] = self._current_resume_path
            logger.info(f"ğŸ“„ ä½¿ç”¨ _current_resume_path: {self._current_resume_path}")

    # æ„å»º ToolCall å¹¶å‘é€
    arguments = json.dumps(tool_args)
    manual_tool_call = ToolCall(
        id=f"call_{tool}",
        function={"name": tool, "arguments": arguments}
    )
    self.tool_calls = [manual_tool_call]
    # ...
```

## cv_reader_agent å·¥å…·

**æ–‡ä»¶**: `app/tool/cv_reader_agent_tool.py`

```python
async def execute(self, section: str = "all", file_path: Optional[str] = None) -> ToolResult:
    # å¦‚æœæä¾›äº†æ–‡ä»¶è·¯å¾„ï¼Œä»æ–‡ä»¶åŠ è½½
    if file_path:
        try:
            from app.utils.resume_parser import parse_markdown_resume
            resume_data = parse_markdown_resume(file_path)
            ResumeDataStore.set_data(resume_data)  # æ›´æ–°å…±äº«å­˜å‚¨
        except Exception as e:
            return ToolResult(error=f"Failed to load resume from file: {str(e)}")
```

## æ•°æ®æµå›¾

```
ç”¨æˆ·è¾“å…¥
"åŠ è½½æˆ‘çš„ç®€å†/Users/xxx/ç®€å†.md"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯: extractResumePath()                  â”‚
â”‚  è¾“å‡º: "/Users/xxx/ç®€å†.md"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket å‘é€                              â”‚
â”‚  { prompt: "...", resume_path: "/Users/..." }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯: server.py                            â”‚
â”‚  resume_path = message.get("resume_path")    â”‚
â”‚  agent._current_resume_path = resume_path   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å›¾è¯†åˆ«: LOAD_RESUME                       â”‚
â”‚  tool = "cv_reader_agent"                    â”‚
â”‚  tool_args = {}                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _handle_direct_tool_call()                 â”‚
â”‚  æ£€æµ‹åˆ° tool_args ä¸ºç©º                       â”‚
â”‚  ä½¿ç”¨ _current_resume_path ä½œä¸º file_path   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cv_reader_agent.execute()                  â”‚
â”‚  parse_markdown_resume(file_path)           â”‚
â”‚  è¿”å›ç®€å†æ•°æ®                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ–‡ä»¶æ‰¾ä¸åˆ°

```
Error: [Errno 2] No such file or directory: 'Users/xxx/...'
```

**åŸå› **: è·¯å¾„ç¼ºå°‘å¼€å¤´çš„ `/`

**æ£€æŸ¥**: å‰ç«¯æ­£åˆ™æ˜¯å¦ä½¿ç”¨ `(\/...)` ç¡®ä¿ä»¥ `/` å¼€å¤´

### 2. å·¥å…·è¢«é‡å¤è°ƒç”¨

**åŸå› **: å»é‡é€»è¾‘ä½¿ç”¨ `tool_name_{step}`ï¼Œstep é€’å¢å¯¼è‡´å»é‡å¤±æ•ˆ

**ä¿®å¤**: ä½¿ç”¨ `tool_call_id` ä½œä¸ºå»é‡é”®

### 3. å‚æ•°ä¸ºç©º {}

**åŸå› **: æ„å›¾è¯†åˆ«æ²¡æœ‰æå– file_pathï¼Œéœ€è¦ä½¿ç”¨ _current_resume_path

**æ£€æŸ¥**: `_handle_direct_tool_call` æ˜¯å¦æ­£ç¡®ä½¿ç”¨ `_current_resume_path`

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `frontend/src/App.jsx` | å‰ç«¯è·¯å¾„æå–å’Œ WebSocket å‘é€ |
| `app/web/server.py` | WebSocket æ¥æ”¶å’Œ session ç®¡ç† |
| `app/agent/manus.py` | æ„å›¾å¤„ç†å’Œç›´æ¥å·¥å…·è°ƒç”¨ |
| `app/memory/conversation_state.py` | æ„å›¾è¯†åˆ« |
| `app/tool/cv_reader_agent_tool.py` | ç®€å†è¯»å–å·¥å…· |
| `app/web/streaming/agent_stream.py` | æµå¼å¤„ç†å’Œå»é‡é€»è¾‘ |
