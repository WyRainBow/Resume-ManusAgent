# Memory ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ v4.0

## 1. æ¦‚è¿°

æœ¬é¡¹ç›®çš„ Memory ç³»ç»Ÿå‚è€ƒ LangChain/LangGraph çš„æ¶æ„è®¾è®¡ï¼Œé’ˆå¯¹ç®€å†ä¼˜åŒ–åœºæ™¯è¿›è¡Œäº†å®šåˆ¶ã€‚ç³»ç»Ÿè´Ÿè´£ç®¡ç†å¯¹è¯å†å²ã€è¿½è¸ªå¯¹è¯çŠ¶æ€ã€è¯†åˆ«ç”¨æˆ·æ„å›¾ã€æ”¯æŒç‰ˆæœ¬å›æº¯å’Œå®ä½“è®°å¿†ã€‚

### è®¾è®¡ç›®æ ‡

- **Agent å·¥å…·è°ƒç”¨æ”¯æŒ**ï¼šå¤šä¸ª Agent ä¹‹é—´å…±äº«å¯¹è¯çŠ¶æ€å’Œç®€å†æ•°æ®
- **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒè¿ç»­çš„å¤šè½®å¯¹è¯ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
- **æ„å›¾è¯†åˆ«**ï¼šåŸºäº LLM çš„æ™ºèƒ½æ„å›¾è¯†åˆ«
- **çŠ¶æ€ç®¡ç†**ï¼šè¿½è¸ªå¯¹è¯çŠ¶æ€å’Œä¼˜åŒ–è¿›åº¦
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ”¯æŒç®€å†ä¼˜åŒ–çš„ç‰ˆæœ¬å›æº¯ï¼ˆCheckpointï¼‰
- **å®ä½“è®°å¿†**ï¼šè‡ªåŠ¨æå–å’Œè®°å¿†ç®€å†ç›¸å…³å®ä½“ï¼ˆå…¬å¸ã€æŠ€èƒ½ã€é¡¹ç›®ç­‰ï¼‰

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `ChatHistoryManager` | å¯¹è¯å†å²å­˜å‚¨ | âœ… å·²å®ç° | `chat_history_manager.py` |
| `ConversationStateManager` | å¯¹è¯çŠ¶æ€å’Œæ„å›¾è¯†åˆ« | âœ… å·²å®ç° | `conversation_state.py` |
| `MessageAdapter` | æ ¼å¼è½¬æ¢ | âœ… å·²å®ç° | `message_adapter.py` |
| `CheckpointSaver` | çŠ¶æ€å¿«ç…§ï¼Œæ”¯æŒå›æº¯ | âœ… å·²å®ç° | `checkpoint_saver.py` |
| `EntityMemory` | å®ä½“è®°å¿†ï¼ˆå…¬å¸ã€æŠ€èƒ½ç­‰ï¼‰ | âœ… å·²å®ç° | `entity_memory.py` |

### 2.2 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Chat UI      â”‚  â”‚ History Btn  â”‚  â”‚ History Sidebar      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚
          â”‚ WebSocket        â”‚ REST API
          â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Backend (FastAPI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              WebSocket Handler (/ws)                      â”‚  â”‚
â”‚  â”‚  - æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯                                           â”‚  â”‚
â”‚  â”‚  - ä¿å­˜åˆ° ChatHistory                                     â”‚  â”‚
â”‚  â”‚  - è°ƒç”¨ Manus Agent                                       â”‚  â”‚
â”‚  â”‚  - è¿”å›æµå¼å“åº”                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /api/history â”‚  â”‚ /api/history â”‚  â”‚ /api/history/rollback â”‚  â”‚
â”‚  â”‚ /chat        â”‚  â”‚ /checkpoints â”‚  â”‚                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                     â”‚
          â–¼                  â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Global Memory Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatHistoryManager   â”‚  â”‚ CheckpointSaver                â”‚  â”‚
â”‚  â”‚ - å­˜å‚¨å¯¹è¯æ¶ˆæ¯        â”‚  â”‚ - ç‰ˆæœ¬å¿«ç…§                     â”‚  â”‚
â”‚  â”‚ - æ”¯æŒä¸Šä¸‹æ–‡æ£€ç´¢      â”‚  â”‚ - ç‰ˆæœ¬å›æ»š                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - ç‰ˆæœ¬å¯¹æ¯”                     â”‚  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EntityMemory                                              â”‚  â”‚
â”‚  â”‚ - æŠ€èƒ½æå–ä¸è®°å¿†                                          â”‚  â”‚
â”‚  â”‚ - å…¬å¸è®°å¿†                                                â”‚  â”‚
â”‚  â”‚ - é¡¹ç›®è®°å¿†                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Manus Agent                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ CVReader     â”‚  â”‚ CVAnalyzer   â”‚  â”‚ CVOptimizer          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ChatHistoryManagerï¼ˆå¯¹è¯å†å²ç®¡ç†ï¼‰

### 3.1 åŠŸèƒ½

```python
class ChatHistoryManager:
    """ç®¡ç†å¯¹è¯å†å²ï¼Œæ”¯æŒä¸Šä¸‹æ–‡ä¿æŒ"""

    def add_message(self, message: Message) -> None
    def get_messages(self, limit: Optional[int] = None) -> List[Message]
    def clear(self) -> None
    def should_wait_for_user(self, last_ai_content: str) -> bool
    def get_context_summary(self, max_tokens: int = 1000) -> str
```

### 3.2 ä¸å…¨å±€çŠ¶æ€é›†æˆ

```python
# server.py ä¸­çš„å…¨å±€å®ä¾‹
_global_chat_history = None

def get_chat_history_sync():
    """è·å–å…¨å±€ ChatHistory å®ä¾‹ (åŒæ­¥ç‰ˆæœ¬)"""
    global _global_chat_history
    if _global_chat_history is None:
        from app.memory import ChatHistoryManager
        _global_chat_history = ChatHistoryManager()
    return _global_chat_history
```

### 3.3 API ç«¯ç‚¹

```
GET /api/history/chat
Response:
{
  "messages": [
    {"role": "user", "content": "...", "timestamp": "..."},
    {"role": "assistant", "content": "...", "timestamp": "..."}
  ]
}
```

---

## 4. Checkpoint æœºåˆ¶ï¼ˆç‰ˆæœ¬å¿«ç…§ä¸å›æº¯ï¼‰

### 4.1 è®¾è®¡æ€è·¯

å‚è€ƒ LangGraph Checkpointerï¼Œä¸ºç®€å†ä¼˜åŒ–æä¾›ç‰ˆæœ¬æ§åˆ¶èƒ½åŠ›ï¼š

| ç‰¹æ€§ | ç®€å†åœºæ™¯åº”ç”¨ |
|------|-------------|
| çŠ¶æ€å¿«ç…§ | ä¿å­˜æ¯æ¬¡ä¼˜åŒ–å‰çš„ç®€å†çŠ¶æ€ |
| æ—¶é—´æ—…è¡Œ | ç”¨æˆ·å¯å›æº¯åˆ°ä»»æ„ä¼˜åŒ–ç‰ˆæœ¬ |
| å¢é‡å­˜å‚¨ | åªä¿å­˜å˜åŒ–éƒ¨åˆ†ï¼ŒèŠ‚çœç©ºé—´ |
| æŒä¹…åŒ– | JSON æ–‡ä»¶å­˜å‚¨ï¼Œé‡å¯åå¯æ¢å¤ |

### 4.2 æ•°æ®ç»“æ„

```python
@dataclass
class Checkpoint:
    version: int
    timestamp: str
    agent: str
    resume_snapshot: ResumeSnapshot
    operation: Operation
    metadata: Optional[CheckpointMetadata] = None
```

### 4.3 ä½¿ç”¨åœºæ™¯

```
åœºæ™¯1: ç”¨æˆ·åæ‚”ä¿®æ”¹
ç”¨æˆ·: "å¸®æˆ‘ä¼˜åŒ–å·¥ä½œç»å†"
    â†“
CheckpointSaver.save(version=1)  # ä¿å­˜ä¼˜åŒ–å‰çŠ¶æ€
    â†“
CVOptimizer æ‰§è¡Œä¼˜åŒ–
    â†“
ç”¨æˆ·: "æˆ‘ä¸å–œæ¬¢è¿™ä¸ªæ”¹æ³•ï¼Œæƒ³å›é€€"
    â†“
CheckpointSaver.rollback(version=1)  # æ¢å¤åˆ°ä¼˜åŒ–å‰

åœºæ™¯2: å¯¹æ¯”ä¸åŒç‰ˆæœ¬
ç”¨æˆ·: "çœ‹çœ‹ä¹‹å‰ç¬¬2ç‰ˆæœ¬æ˜¯æ€ä¹ˆå†™çš„"
    â†“
CheckpointSaver.get_version(2)
    â†“
æ˜¾ç¤ºç‰ˆæœ¬2çš„å†…å®¹ï¼Œå¯ä¸å½“å‰ç‰ˆæœ¬å¯¹æ¯”
```

### 4.4 API ç«¯ç‚¹

```
GET /api/history/checkpoints
Response:
{
  "checkpoints": [
    {"version": 1, "timestamp": "...", "action": "...", "agent": "..."}
  ]
}

POST /api/history/rollback/{version}
Response:
{
  "success": true,
  "version": 1,
  "message": "å·²å›æ»šåˆ°ç‰ˆæœ¬ 1"
}
```

---

## 5. EntityMemoryï¼ˆå®ä½“è®°å¿†ï¼‰

### 5.1 è®¾è®¡æ€è·¯

å‚è€ƒ CrewAI Entity Memoryï¼Œè‡ªåŠ¨æå–å’Œè®°å¿†ç®€å†ç›¸å…³å®ä½“ï¼š

| å®ä½“ç±»å‹ | ç¤ºä¾‹ | åº”ç”¨åœºæ™¯ |
|---------|------|---------|
| ç›®æ ‡å²—ä½ | Senior Engineer, PM | è°ƒæ•´ä¼˜åŒ–è¯­æ°”å’Œé‡ç‚¹ |
| ç›®æ ‡å…¬å¸ | Google, Meta, å­—èŠ‚ | ä¼˜åŒ–æ—¶çªå‡ºç›¸å…³ç»å† |
| æ ¸å¿ƒæŠ€èƒ½ | Python, React, LLM | åŒ¹é…å²—ä½éœ€æ±‚ |
| å·¥ä½œå¹´é™ | 5å¹´, 3å¹´ | åˆ¤æ–­èµ„å†æ·±æµ… |
| é¡¹ç›®ç»å† | å¼€æºé¡¹ç›®ã€å†…éƒ¨é¡¹ç›® | è¡¥å……ç»†èŠ‚å’Œæˆæœ |

### 5.2 æ•°æ®ç»“æ„

```python
@dataclass
class ExtractedEntities:
    skills: List[Skill]
    companies: List[Company]
    projects: List[Project]
    targets: Targets
```

### 5.3 API

```python
class EntityMemory:
    def extract(self, text: str, source: str = "conversation") -> Dict[str, Any]
    def update_targets(self, role: str, companies: List[str])
    def update_skills(self, skills: List[Dict])
    def update_companies(self, companies: List[Dict])
    def update_projects(self, projects: List[Dict])
    def search(self, keyword: str) -> List[Dict]
    def get_matching_skills(self, target_role: str) -> Dict
    def add_association(self, skill: str, related_projects: List[str])
```

---

## 6. å¯¹è¯æµç¨‹ä¸æ•°æ®æµ

### 6.1 å®Œæ•´å¯¹è¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥ (WebSocket)
    â†“
[ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° ChatHistory]
    â†“
ConversationStateManager: æ„å›¾è¯†åˆ«
    â†“
EntityMemory: æ£€ç´¢ç›¸å…³å®ä½“ï¼ˆå…¬å¸ã€æŠ€èƒ½ç­‰ï¼‰
    â†“
CheckpointSaver: ä¿å­˜å½“å‰çŠ¶æ€å¿«ç…§ï¼ˆå¦‚éœ€ä¿®æ”¹ï¼‰
    â†“
Agent æ‰§è¡Œï¼ˆCVReader/Analyzer/Optimizer/Editorï¼‰
    â†“
[ä¿å­˜ AI å›å¤åˆ° ChatHistory]
    â†“
EntityMemory: æ›´æ–°å®ä½“ï¼ˆå¦‚æœ‰æ–°ä¿¡æ¯ï¼‰
    â†“
è¿”å›å“åº” (WebSocket)
```

### 6.2 Agent åä½œæµç¨‹

```
ç”¨æˆ·: "å¸®æˆ‘ä¼˜åŒ–å·¥ä½œç»å†ï¼Œç›®æ ‡æ˜¯æŠ•é€’ Google"
    â†“
Manus: æ„å›¾è¯†åˆ« â†’ OPTIMIZE_SECTION
    â†“
EntityMemory: æå–å®ä½“ {target_company: "Google"}
    â†“
CheckpointSaver.save(version=1)  # ä¿å­˜ä¼˜åŒ–å‰çŠ¶æ€
    â†“
CVReader: è¯»å–å·¥ä½œç»å†æ•°æ®
    â†“
CVAnalyzer: åˆ†æå·¥ä½œç»å†è´¨é‡
    â†“
CVOptimizer: ç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼ˆè€ƒè™‘ Google åå¥½ï¼‰
    â†“
ç”¨æˆ·: "å¯ä»¥ï¼Œå¸®æˆ‘ä¿®æ”¹"
    â†“
CVEditor: åº”ç”¨ä¿®æ”¹
    â†“
CheckpointSaver.save(version=2)  # ä¿å­˜ä¿®æ”¹åçŠ¶æ€
```

---

## 7. ä¸ LangChain/LangGraph å¯¹æ¯”

### 7.1 æ¦‚å¿µæ˜ å°„

| LangChain/LangGraph | æœ¬é¡¹ç›®å®ç° | è¯´æ˜ |
|---------------------|-----------|------|
| StateGraph | ConversationStateManager | çŠ¶æ€ç®¡ç† |
| Checkpointer | CheckpointSaver | å¿«ç…§å’Œå›æº¯ |
| Store (namespace) | EntityMemory | å®ä½“è®°å¿† |
| RunnableWithMessageHistory | ChatHistoryManager | æ¶ˆæ¯å†å² |

### 7.2 å·®å¼‚åŒ–è®¾è®¡

| ç‰¹æ€§ | LangGraph | æœ¬é¡¹ç›® |
|------|-----------|--------|
| å¤æ‚åº¦ | å›¾çŠ¶æ€æœºï¼Œå¤æ‚ | ç®€åŒ–çŠ¶æ€ï¼Œå¤Ÿç”¨ |
| æŒä¹…åŒ– | å¤šç§æ•°æ®åº“ | JSON æ–‡ä»¶ï¼ˆè½»é‡ï¼‰ |
| å›æº¯ | å®Œæ•´æ—¶é—´æ—…è¡Œ | ç‰ˆæœ¬å›æº¯ï¼ˆç®€å†åœºæ™¯ï¼‰ |
| å®ä½“è®°å¿† | éœ€è‡ªè¡Œå®ç° | å†…ç½®ï¼Œé’ˆå¯¹ç®€å†ä¼˜åŒ– |
| ä¼šè¯éš”ç¦» | thread_id | å•ä¼šè¯ï¼ˆæš‚ä¸éœ€è¦ï¼‰ |

---

## 8. å‰ç«¯é›†æˆ

### 8.1 History UI ç»„ä»¶

```javascript
// App.jsx
const [showHistory, setShowHistory] = useState(false);
const [chatHistory, setChatHistory] = useState([]);
const [checkpointHistory, setCheckpointHistory] = useState([]);

// è·å–å†å²æ•°æ®
const fetchHistory = async () => {
  const chatRes = await fetch('/api/history/chat');
  const chatData = await chatRes.json();
  setChatHistory(chatData.messages || []);

  const checkpointRes = await fetch('/api/history/checkpoints');
  const checkpointData = await checkpointRes.json();
  setCheckpointHistory(checkpointData.checkpoints || []);
};
```

### 8.2 å†å²ä¾§è¾¹æ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†å²è®°å½•                    [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç®€å†ç‰ˆæœ¬å†å²                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç‰ˆæœ¬ 1        10:30       â”‚  â”‚
â”‚  â”‚ åˆ†æç®€å†     Agent: manus â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç‰ˆæœ¬ 2        10:35       â”‚  â”‚
â”‚  â”‚ ä¼˜åŒ–å·¥ä½œç»å† Agent: manus â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è¯å†å²                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ‘¤ ç”¨æˆ·                   â”‚  â”‚
â”‚  â”‚ ä½ å¥½                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¤– AI                     â”‚  â”‚
â”‚  â”‚ ä½ å¥½ï¼æˆ‘æ˜¯...            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. çŠ¶æ€ç®¡ç†

### 9.1 å¯¹è¯çŠ¶æ€ (ConversationState)

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| IDLE | åˆå§‹çŠ¶æ€ |
| GREETING | é—®å€™çŠ¶æ€ |
| RESUME_LOADED | ç®€å†å·²åŠ è½½ |
| ANALYZING | åˆ†æä¸­ |
| OPTIMIZING | ä¼˜åŒ–ä¸­ |
| WAITING_ANSWER | ç­‰å¾…ç”¨æˆ·å›ç­” |
| EDITING | ç¼–è¾‘ä¸­ |

### 9.2 ç”¨æˆ·æ„å›¾ (Intent)

| æ„å›¾ | è¯´æ˜ |
|------|------|
| GREETING | é—®å€™ |
| LOAD_RESUME | åŠ è½½ç®€å† |
| VIEW_RESUME | æŸ¥çœ‹ç®€å† |
| ANALYZE | åˆ†æç®€å† |
| OPTIMIZE | ä¼˜åŒ–ç®€å† |
| OPTIMIZE_SECTION | ä¼˜åŒ–ç‰¹å®šæ¨¡å— |
| ANSWER_QUESTION | å›ç­”é—®é¢˜ |
| CONFIRM | ç¡®è®¤ |
| CANCEL | å–æ¶ˆ |
| ROLLBACK | å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬ |

---

## 10. å®æ–½çŠ¶æ€

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒæ‰©å±•ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] ChatHistoryManager
- [x] ConversationStateManager
- [x] MessageAdapter
- [x] LangChain é£æ ¼æ¶ˆæ¯ç±»å‹

### é˜¶æ®µäºŒï¼šCheckpoint æœºåˆ¶ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] CheckpointSaver å®ç°
- [x] ç‰ˆæœ¬ä¿å­˜ä¸åŠ è½½
- [x] ç‰ˆæœ¬å¯¹æ¯”
- [x] ä¸€é”®å›æ»š
- [x] API ç«¯ç‚¹

### é˜¶æ®µä¸‰ï¼šå®ä½“è®°å¿†ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] EntityMemory å®ç°
- [x] è‡ªåŠ¨æå–å®ä½“
- [x] å®ä½“å…³è”ï¼ˆæŠ€èƒ½-å²—ä½ï¼‰
- [x] æœç´¢ä¸åŒ¹é…

### é˜¶æ®µå››ï¼šå‰ç«¯é›†æˆï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] å†å²æŒ‰é’®
- [x] å†å²ä¾§è¾¹æ 
- [x] èŠå¤©å†å²æ˜¾ç¤º
- [x] Checkpoint å†å²æ˜¾ç¤º

---

## 11. æ–‡ä»¶ç»“æ„

```
app/memory/
â”œâ”€â”€ __init__.py                       # å¯¼å‡ºæ¥å£
â”œâ”€â”€ langchain/                        # LangChain é£æ ¼ç»„ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ messages/
â”‚   â”‚   â””â”€â”€ __init__.py              # æ¶ˆæ¯ç±»å‹
â”‚   â””â”€â”€ chat_history.py              # èŠå¤©å†å²
â”œâ”€â”€ message_adapter.py                # æ ¼å¼è½¬æ¢
â”œâ”€â”€ chat_history_manager.py           # èŠå¤©å†å²ç®¡ç†
â”œâ”€â”€ conversation_state.py             # å¯¹è¯çŠ¶æ€ç®¡ç†
â”œâ”€â”€ checkpoint_saver.py               # ç‰ˆæœ¬å¿«ç…§ä¸å›æº¯
â””â”€â”€ entity_memory.py                  # å®ä½“è®°å¿†

app/web/
â””â”€â”€ server.py                         # FastAPI æœåŠ¡å™¨
    - WebSocket ç«¯ç‚¹
    - History API ç«¯ç‚¹
    - å…¨å±€ ChatHistory é›†æˆ
    - å…¨å±€ CheckpointSaver é›†æˆ

frontend/src/
â”œâ”€â”€ App.jsx                           # ä¸»åº”ç”¨
â”‚   - History çŠ¶æ€ç®¡ç†
â”‚   - fetchHistory å‡½æ•°
â”‚   - å†å²ä¾§è¾¹æ  UI
â””â”€â”€ utils/
    â””â”€â”€ logger.js                     # æ—¥å¿—å·¥å…·
```

---

## 12. æµ‹è¯•

### 12.1 å•å…ƒæµ‹è¯•

- `test_memory_system.py` - åŸºç¡€ç»„ä»¶æµ‹è¯•
- `test_checkpoint_and_entity.py` - Checkpoint å’Œ Entity æµ‹è¯•
- `test_multi_turn.py` - å¤šè½®å¯¹è¯æµ‹è¯•

### 12.2 é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•å¤šè½®å¯¹è¯
python test_multi_turn.py

# æµ‹è¯• WebSocket èŠå¤©
python test_websocket_chat.py

# å‰ç«¯æµ‹è¯•
# è®¿é—® http://localhost:5173
```

---

## 13. æœªæ¥æ‰©å±•

- [ ] å¤šä¼šè¯éš”ç¦»ï¼ˆthread_id/user_idï¼‰
- [ ] åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆRedis/æ•°æ®åº“ï¼‰
- [ ] æ›´ç²¾ç»†çš„ä¸Šä¸‹æ–‡ç¼©å‡ç­–ç•¥
- [ ] è·¨ä¼šè¯çš„é•¿æœŸè®°å¿†
