# ä¸Šä¸‹æ–‡æ¢å¤æœºåˆ¶

## æ¦‚è¿°

å®ç°é¡µé¢åˆ·æ–°å AI ä»èƒ½è®°ä½ä¹‹å‰å¯¹è¯å†…å®¹çš„åŠŸèƒ½ï¼Œé€šè¿‡ WebSocket åœ¨å‰åç«¯ä¹‹é—´åŒæ­¥å†å²æ¶ˆæ¯ã€‚

## å®ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æµç¨‹å›¾                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. ç”¨æˆ·åˆ·æ–°é¡µé¢                                                â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  2. å‰ç«¯ä» localStorage åŠ è½½å†å²æ¶ˆæ¯                              â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  3. WebSocket è¿æ¥å»ºç«‹                                          â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”œâ”€â–º å‰ç«¯: å‘é€ restore_history + å†å²æ¶ˆæ¯                       â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  4. åç«¯æ¥æ”¶ restore_history                                     â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”œâ”€â–º æ¢å¤åˆ° global_chat_history                               â”‚
â”‚     â””â”€â–º æ¢å¤åˆ° agent.memory                                     â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  5. Agent ç°åœ¨æœ‰äº†ä¹‹å‰çš„ä¸Šä¸‹æ–‡                                   â”‚
â”‚     â”‚                                                            â”‚
â”‚     â””â”€â–º ç”¨æˆ·ç»§ç»­å¯¹è¯ï¼ŒAI èƒ½è®°ä½ä¹‹å‰çš„å†…å®¹                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `frontend/src/App.jsx` | WebSocket è¿æ¥æ—¶å‘é€å†å²æ¶ˆæ¯ |
| `app/web/server.py` | æ¥æ”¶ restore_history å¹¶æ¢å¤åˆ° Agent |

## å‰ç«¯å®ç°

### localStorage å·¥å…·å‡½æ•°

```javascript
const STORAGE_KEYS = {
  MESSAGES: 'openmanus_chat_messages',
  RESUME_DATA: 'openmanus_resume_data',
  SHOW_RESUME_PANEL: 'openmanus_show_resume_panel'
};

const loadMessagesFromStorage = () => {
  const stored = localStorage.getItem(STORAGE_KEYS.MESSAGES);
  if (stored) {
    const parsed = JSON.parse(stored);
    console.log(`ğŸ“œ æ¢å¤ ${parsed.length} æ¡å†å²æ¶ˆæ¯`);
    return parsed;
  }
  return [];
};

const saveMessagesToStorage = (messages) => {
  const toSave = messages.slice(-100); // ä¿å­˜æœ€è¿‘ 100 æ¡
  localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(toSave));
};
```

### WebSocket è¿æ¥æ—¶æ¢å¤å†å²

```javascript
socket.onopen = () => {
  console.log('Connected to WebSocket');
  setStatus('idle');
  setWs(socket);

  // å‘é€å†å²æ¶ˆæ¯ç»™åç«¯ç”¨äºæ¢å¤ä¸Šä¸‹æ–‡
  const storedMessages = loadMessagesFromStorage();
  if (storedMessages.length > 0) {
    // åªå‘é€ç”¨æˆ·å’ŒåŠ©æ‰‹çš„å¯¹è¯æ¶ˆæ¯ï¼Œè¿‡æ»¤æ‰å·¥å…·è°ƒç”¨ç­‰
    const conversationMessages = storedMessages.filter(msg =>
      msg.role === 'user' || (msg.role === 'agent' && msg.type === 'answer')
    );

    if (conversationMessages.length > 0) {
      console.log(`ğŸ“œ å‘é€ ${conversationMessages.length} æ¡å†å²æ¶ˆæ¯åˆ°åç«¯`);
      socket.send(JSON.stringify({
        type: 'restore_history',
        messages: conversationMessages.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content || ''
        }))
      }));
    }
  }
};
```

## åç«¯å®ç°

### WebSocket æ¶ˆæ¯å¤„ç†

```python
# å¤„ç†å‰ç«¯å‘æ¥çš„å†å²æ¶ˆæ¯æ¢å¤è¯·æ±‚
if message.get("type") == "restore_history":
    history_messages = message.get("messages", [])
    if history_messages:
        logger.info(f"ğŸ“œ ä»å‰ç«¯æ¢å¤ {len(history_messages)} æ¡å†å²æ¶ˆæ¯")
        for msg in history_messages:
            role = msg.get("role", "user")
            content = msg.get("content", "")
            if role == "user":
                global_chat_history.add_message(Message.user_message(content))
                agent.memory.add_message(Message.user_message(content))
            elif role == "assistant":
                global_chat_history.add_message(Message.assistant_message(content))
                agent.memory.add_message(Message.assistant_message(content))
    continue
```

## æ•ˆæœ

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| ç”¨æˆ·åˆ·æ–°é¡µé¢ | âœ… |
| å‰ç«¯æ¢å¤èŠå¤©å†å²æ˜¾ç¤º | âœ… |
| å‰ç«¯å‘é€å†å²æ¶ˆæ¯ç»™åç«¯ | âœ… |
| åç«¯æ¢å¤åˆ° Agent memory | âœ… |
| AI ç»§ç»­å¯¹è¯æ—¶èƒ½è®°ä½ä¹‹å‰çš„ä¸Šä¸‹æ–‡ | âœ… |

## æµ‹è¯•æ–¹æ³•

1. å¯åŠ¨å‰åç«¯æœåŠ¡
2. ä¸ AI è¿›è¡Œå¯¹è¯
3. åˆ·æ–°æµè§ˆå™¨é¡µé¢
4. ç»§ç»­ä¸ AI å¯¹è¯ï¼ŒéªŒè¯ AI æ˜¯å¦è®°å¾—ä¹‹å‰çš„å†…å®¹

## æŠ€æœ¯ç»†èŠ‚

### æ¶ˆæ¯è¿‡æ»¤

å‰ç«¯å‘é€æ—¶åªåŒ…å«æœ‰æ•ˆå¯¹è¯æ¶ˆæ¯ï¼š
- `user` ç±»å‹çš„æ¶ˆæ¯
- `agent` ä¸” `type === 'answer'` çš„æ¶ˆæ¯

è¿‡æ»¤æ‰çš„æ¶ˆæ¯ç±»å‹ï¼š
- `tool_call` - å·¥å…·è°ƒç”¨
- `tool_result` - å·¥å…·è¿”å›ç»“æœ
- `step` - æ­¥éª¤ä¿¡æ¯
- `thought` - æ€è€ƒè¿‡ç¨‹

### æ¶ˆæ¯æ˜ å°„

å‰ç«¯åˆ°åç«¯çš„è§’è‰²æ˜ å°„ï¼š
| å‰ç«¯ role | åç«¯ role |
|-----------|-----------|
| `user` | `user` |
| `agent` (type=answer) | `assistant` |
